<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Citation Slice POC</title>
  <style>
    #drop_zone {
      width: 150px;
      height: 80px;
      margin: 0;
      border: 2px dashed #999;
      border-radius: 8px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
      cursor: pointer;
    }
    #progress {
      width: 90%; max-width:500px;
      margin: 10px auto;
      display: none;
    }
    #output {
      white-space: pre-wrap;
      width: 90%; max-width:800px;
      margin: 10px auto;
    }
    #graph {
      width: 90%;
      max-width: 800px;
      height: calc(100vh - 200px);
      margin: 20px auto;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    /* Controls panel above graph */
    #controls {
      display: flex;
      gap: 20px;
      margin: 10px auto;
      width: 90%;
      max-width: 800px;
      align-items: center;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">PDF Citation Slice POC</h1>
  <div id="controls">
    <div id="drop_zone">Drop PDF file here</div>
    <a href="/network" style="margin-left:20px; text-decoration:none; font-weight:bold;">Advanced Network Dashboard</a>
    <progress id="progress" max="100" value="0"></progress>
    <label>Depth:
      <input type="number" id="depth" min="0" max="5" value="1" style="width:50px;"/>
    </label>
    <button id="snapshot" style="margin-left:20px;">Snapshot</button>
  </div>
  <div id="summary" style="width:90%; max-width:800px; margin:10px auto; font-size:14px; color:#333;"></div>
  <svg id="graph"></svg>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  const dropZone = document.getElementById('drop_zone');
  const progress = document.getElementById('progress');
  // const output removed
  const svg = d3.select('#graph');
  // Container for pan & zoom
  const container = svg.append('g');
  // Zoom and pan behavior
  const zoom = d3.zoom()
    .scaleExtent([0.2, 5])
    .on('zoom', event => { container.attr('transform', event.transform); });
  svg.call(zoom);
  // Helper to get SVG dimensions
  function getDimensions() {
    const bbox = svg.node().getBoundingClientRect();
    return { width: bbox.width, height: bbox.height };
  }

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#00a';
  });
  dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = '#888';
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#888';
    const file = e.dataTransfer.files[0];
    if (!file || file.type !== 'application/pdf') {
      alert('Please drop a PDF file.');
      return;
    }
    uploadFile(file);
  });

  async function uploadFile(file) {
    progress.style.display = 'block';
    progress.value = 0;
    // clear previous graph
    container.selectAll('*').remove();

    const formData = new FormData();
    formData.append('file', file);

    // Include depth parameter from input
    const depthVal = document.getElementById('depth').value;
    const response = await fetch(`/upload?depth=${depthVal}`, {
      method: 'POST',
      body: formData,
    });
    if (!response.ok) {
      const err = await response.json();
      alert('Error: ' + (err.error || response.statusText));
      progress.style.display = 'none';
      return;
    }
    const data = await response.json();
    progress.style.display = 'none';
    // Render graph and update summary
    renderGraph(data);
    try {
      // Cache for reuse
      localStorage.setItem('citationGraph', JSON.stringify(data));
    } catch (e) {}
    // Display stage summary
    const sum = document.getElementById('summary');
    if (data.stats && data.stats.counts) {
      const s = data.stats;
      sum.textContent = `Nodes: ${s.counts.total_nodes}, Edges: ${s.counts.total_edges}. ` +
        `Parse: ${s.pdf_parse_ms}ms, Citations: ${s.initial_citations_ms}ms, ` +
        `Crawl: ${s.crawl_ms}ms, Total: ${s.total_ms}ms.`;
    } else {
      sum.textContent = `Nodes: ${data.nodes.length}, Edges: ${data.edges.length}.`;
    }
  }

  function renderGraph(data) {
    // determine SVG dimensions for force layout
    const { width, height } = getDimensions();
    const nodes = data.nodes;
    const links = data.edges.map(e => Object.assign({}, e));

    const simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d => d.id).distance(100))
      .force('charge', d3.forceManyBody().strength(-300))
      .force('x', d3.forceX().x(d => d.type === 'document' ? width - 50 : 50).strength(1))
      .force('y', d3.forceY().y(height / 2).strength(0.1));

    svg.attr('viewBox', [0, 0, width, height]);

    const link = container.append('g')
      .attr('stroke', '#999')
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('stroke-width', 1.5);

    const node = container.append('g')
      .attr('stroke', '#fff')
      .attr('stroke-width', 1.5)
      .selectAll('circle')
      .data(nodes)
      .join('circle')
      .attr('r', 10)
      .attr('fill', d => {
        if (d.type === 'document') return '#f00';
        if (d.type === 'online_source') return '#00f';
        if (d.type === 'offline_source') return '#0a0';
        if (d.type === 'pruned_online_source') return '#888';
        return '#ccc';
      })
      .call(d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended)
      );

    const label = container.append('g')
      .selectAll('text')
      .data(nodes)
      .join('text')
      .text(d => d.id)
      .attr('x', 12)
      .attr('y', '0.31em')
      .style('font-size', '10px');

    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
      node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);
      label
        .attr('x', d => d.x)
        .attr('y', d => d.y);
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }
    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }
    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  }

  // On load, try to use cached graph; otherwise render sample graph
  const sampleData = {
    nodes: [
      { id: 'document', label: 'SampleDoc', type: 'document' },
      { id: 'url:http://example.com', label: 'http://example.com', type: 'online_source' }
    ],
    edges: [ { source: 'document', target: 'url:http://example.com' } ]
  };
  (function initGraph() {
    const sum = document.getElementById('summary');
    try {
      const cached = localStorage.getItem('citationGraph');
      if (cached) {
        const data = JSON.parse(cached);
        renderGraph(data);
        // Display summary if stats present
        if (data.stats && data.stats.counts) {
          const s = data.stats;
          sum.textContent = `Nodes: ${s.counts.total_nodes}, Edges: ${s.counts.total_edges}. ` +
            `Parse: ${s.pdf_parse_ms}ms, Citations: ${s.initial_citations_ms}ms, ` +
            `Crawl: ${s.crawl_ms}ms, Total: ${s.total_ms}ms.`;
        }
        return;
      }
    } catch (e) {}
    // Fallback sample
    renderGraph(sampleData);
  })();
  // Snapshot: download current SVG graph
  document.getElementById('snapshot').addEventListener('click', () => {
    const svgEl = document.getElementById('graph');
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgEl);
    // Add namespace if missing
    if (!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
      source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'citation-graph.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });

  </script>
</body>
</html>